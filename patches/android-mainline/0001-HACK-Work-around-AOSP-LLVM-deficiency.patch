From 200850d4cf02ea3b926cae5edeaa41a063c53edc Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <nathan@kernel.org>
Date: Tue, 11 Jan 2022 10:33:02 -0700
Subject: [PATCH] HACK: Work around AOSP LLVM deficiency

Link: https://github.com/ClangBuiltLinux/linux/issues/1561
Signed-off-by: Nathan Chancellor <nathan@kernel.org>
---
 arch/arm/include/asm/current.h | 3 ++-
 init/Kconfig                   | 3 +++
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/arch/arm/include/asm/current.h b/arch/arm/include/asm/current.h
index 6bf0aad672c3..70c6721cff14 100644
--- a/arch/arm/include/asm/current.h
+++ b/arch/arm/include/asm/current.h
@@ -28,7 +28,8 @@ static inline struct task_struct *get_current(void)
 
 #if __has_builtin(__builtin_thread_pointer) && \
     !(defined(CONFIG_THUMB2_KERNEL) && \
-      defined(CONFIG_CC_IS_CLANG) && CONFIG_CLANG_VERSION < 130001)
+      ((defined(CONFIG_CC_IS_CLANG) && CONFIG_CLANG_VERSION < 130001) || \
+       defined(CONFIG_CC_IS_ANDROID_CLANG)))
 	/*
 	 * Use the __builtin helper when available - this results in better
 	 * code, especially when using GCC in combination with the per-task
diff --git a/init/Kconfig b/init/Kconfig
index ec589e5c1b8c..cc193fbbdf09 100644
--- a/init/Kconfig
+++ b/init/Kconfig
@@ -27,6 +27,9 @@ config GCC_VERSION
 config CC_IS_CLANG
 	def_bool $(success,test "$(cc-name)" = Clang)
 
+config CC_IS_ANDROID_CLANG
+	def_bool $(success,echo "$(CC_VERSION_TEXT)" | grep -q Android)
+
 config CLANG_VERSION
 	int
 	default $(cc-version) if CC_IS_CLANG
-- 
2.34.1

